name: Docker Image CI Pull

on:
  workflow_dispatch:  # 允许手动触发工作流

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # 允许单个镜像失败不影响其他镜像
      matrix:
        architecture: [amd64]
        service:
          - name: ragflow
            source: infiniflow/ragflow
            tag: v0.9.0

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: crpi-ula1bfbb1264p5ln.cn-hangzhou.personal.cr.aliyuncs.com
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: Pull and push Docker image
        continue-on-error: true
        run: |
          set +e
          
          ARCHITECTURE="${{ matrix.architecture }}"
          REGISTRY="crpi-ula1bfbb1264p5ln.cn-hangzhou.personal.cr.aliyuncs.com"
          NAMESPACE="muagent_gz"
          # 使用正确的源镜像路径（从 Docker Hub 拉取）
          SOURCE_IMAGE="${{ matrix.service.source }}:${{ matrix.service.tag }}"
          TARGET_IMAGE="${REGISTRY}/${NAMESPACE}/${{ matrix.service.name }}:${{ matrix.service.tag }}-${ARCHITECTURE}"
          
          echo "=========================================="
          echo "Processing: ${{ matrix.service.name }}"
          echo "Source Image: $SOURCE_IMAGE"
          echo "Target Image: $TARGET_IMAGE"
          echo "Platform: linux/${ARCHITECTURE}"
          echo "Registry: ${REGISTRY}"
          echo "Namespace: ${NAMESPACE}"
          echo "=========================================="
          
          # 验证镜像路径格式
          if [[ "$SOURCE_IMAGE" == *"ghcr.io"* ]] || [[ "$SOURCE_IMAGE" == *"codefuse-ai"* ]]; then
            echo "❌ ERROR: Invalid source image path detected: $SOURCE_IMAGE"
            echo "Expected format: infiniflow/ragflow:v0.9.0"
            exit 1
          fi
          
          # 拉取源镜像，添加重试机制
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempting to pull: $SOURCE_IMAGE (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
            if docker pull --platform linux/${ARCHITECTURE} "$SOURCE_IMAGE"; then
              echo "✅ Successfully pulled: $SOURCE_IMAGE"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "⚠️ Pull failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
                sleep 5
              else
                echo "❌ Failed to pull $SOURCE_IMAGE after $MAX_RETRIES attempts"
                echo "Please verify the image exists at: https://hub.docker.com/r/${{ matrix.service.source }}"
                exit 1
              fi
            fi
          done
          
          # 标记镜像
          docker tag "$SOURCE_IMAGE" "$TARGET_IMAGE"
          echo "✅ Tagged: $TARGET_IMAGE"
          
          # 推送镜像到阿里云，添加重试机制
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempting to push: $TARGET_IMAGE (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
            if docker push "$TARGET_IMAGE"; then
              echo "✅ Successfully pushed: $TARGET_IMAGE"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "⚠️ Push failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
                sleep 5
              else
                echo "❌ Failed to push $TARGET_IMAGE after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done
          
          echo "✅ Completed: ${{ matrix.service.name }}"

      - name: Clean up
        if: always()
        run: |
          echo "Cleaning up Docker system..."
          docker system prune -af --volumes || true
          echo "Cleanup completed"
