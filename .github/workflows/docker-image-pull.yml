name: Sync Docker Images to Aliyun

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Image name to sync (e.g., ragflow)'
        required: true
        type: string
      image_tag:
        description: 'Image tag (e.g., v0.9.0)'
        required: true
        type: string
      source_registry:
        description: 'Source registry (default: docker.io)'
        required: false
        default: 'docker.io'
        type: string
      target_registry:
        description: 'Target Aliyun registry'
        required: true
        type: string
      target_namespace:
        description: 'Target namespace'
        required: true
        type: string
      platform:
        description: 'Platform (e.g., linux/amd64, linux/arm64)'
        required: false
        default: 'linux/amd64'
        type: string

env:
  DOCKER_CLI_EXPERIMENTAL: enabled

jobs:
  sync-image:
    runs-on: ubuntu-latest
    steps:
      - name: Set up variables
        id: vars
        run: |
          SOURCE_REGISTRY="${{ inputs.source_registry }}"
          IMAGE_NAME="${{ inputs.image_name }}"
          IMAGE_TAG="${{ inputs.image_tag }}"
          TARGET_REGISTRY="${{ inputs.target_registry }}"
          TARGET_NAMESPACE="${{ inputs.target_namespace }}"
          PLATFORM="${{ inputs.platform }}"
          
          # 构建源镜像名称
          if [ "$SOURCE_REGISTRY" = "docker.io" ]; then
            SOURCE_IMAGE="infiniflow/${IMAGE_NAME}:${IMAGE_TAG}"
          else
            SOURCE_IMAGE="${SOURCE_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}"
          fi
          
          # 构建目标镜像名称（从 platform 中提取架构，如 linux/amd64 -> amd64）
          ARCH="${PLATFORM#linux/}"
          TARGET_IMAGE="${TARGET_REGISTRY}/${TARGET_NAMESPACE}/${IMAGE_NAME}:${IMAGE_TAG}-${ARCH}"
          
          echo "SOURCE_IMAGE=${SOURCE_IMAGE}" >> $GITHUB_ENV
          echo "TARGET_IMAGE=${TARGET_IMAGE}" >> $GITHUB_ENV
          echo "PLATFORM=${PLATFORM}" >> $GITHUB_ENV
          echo "TARGET_REGISTRY=${TARGET_REGISTRY}" >> $GITHUB_ENV

      - name: Clean up Docker space before pull
        run: |
          echo "=== 清理 Docker 空间 ==="
          # 清理未使用的容器
          docker container prune -f || true
          # 清理未使用的镜像
          docker image prune -a -f || true
          # 清理构建缓存
          docker builder prune -a -f || true
          # 清理未使用的卷
          docker volume prune -f || true
          # 清理未使用的网络
          docker network prune -f || true
          # 显示磁盘使用情况
          df -h
          docker system df

      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.TARGET_REGISTRY }}
          username: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
          password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}

      - name: Pull and push image (with cleanup)
        run: |
          set +e
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "=== 尝试拉取镜像 (第 $((RETRY_COUNT + 1)) 次) ==="
            
            # 清理空间（每次重试前都清理）
            if [ $RETRY_COUNT -gt 0 ]; then
              echo "清理 Docker 空间..."
              docker system prune -a -f --volumes || true
              df -h
            fi
            
            # 使用 --platform 参数只拉取指定平台，减少空间占用
            if docker pull --platform ${{ env.PLATFORM }} ${{ env.SOURCE_IMAGE }}; then
              echo "✓ 镜像拉取成功"
              
              # 立即标记为目标镜像
              docker tag ${{ env.SOURCE_IMAGE }} ${{ env.TARGET_IMAGE }}
              
              # 推送到阿里云
              echo "=== 推送镜像到阿里云 ==="
              if docker push ${{ env.TARGET_IMAGE }}; then
                echo "✓ 镜像推送成功"
                
                # 推送成功后立即删除本地镜像以释放空间
                echo "=== 清理本地镜像 ==="
                docker rmi ${{ env.SOURCE_IMAGE }} ${{ env.TARGET_IMAGE }} || true
                docker system prune -f || true
                
                echo "✓ 镜像同步完成"
                exit 0
              else
                echo "✗ 镜像推送失败"
                docker rmi ${{ env.SOURCE_IMAGE }} ${{ env.TARGET_IMAGE }} || true
                exit 1
              fi
            else
              echo "✗ 镜像拉取失败"
              RETRY_COUNT=$((RETRY_COUNT + 1))
              
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "等待 10 秒后重试..."
                sleep 10
              fi
            fi
          done
          
          echo "✗ 镜像拉取失败，已重试 $MAX_RETRIES 次"
          exit 1

      - name: Final cleanup
        if: always()
        run: |
          echo "=== 最终清理 ==="
          docker system prune -a -f --volumes || true
          df -h
          docker system df

