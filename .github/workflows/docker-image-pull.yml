name: Docker Image CI Pull

on:
  workflow_dispatch:  # 允许手动触发工作流

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # 允许单个镜像失败不影响其他镜像
      matrix:
        architecture: [amd64]
        service:
          # 核心服务镜像
          - name: ragflow
            source: infiniflow/ragflow
            tag: v0.9.0
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Initial Docker cleanup
        run: |
          echo "=== 初始清理 Docker 空间 ==="
          docker container prune -f || true
          docker image prune -a -f || true
          docker builder prune -a -f || true
          docker volume prune -f || true
          docker network prune -f || true
          echo "=== 磁盘使用情况 ==="
          df -h
          docker system df
      
      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: crpi-ula1bfbb1264p5ln.cn-hangzhou.personal.cr.aliyuncs.com
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: Pull and push Docker image
        continue-on-error: true
        run: |
          set +e
          
          ARCHITECTURE="${{ matrix.architecture }}"
          REGISTRY="crpi-ula1bfbb1264p5ln.cn-hangzhou.personal.cr.aliyuncs.com"
          NAMESPACE="muagent_gz"
          
          # 处理包含完整 registry 路径的镜像（如 quay.io/minio/minio）
          SOURCE_IMAGE="${{ matrix.service.source }}:${{ matrix.service.tag }}"
          
          # 生成目标镜像名称（处理特殊字符，如 RELEASE.2025-06-13T11-33-47Z）
          # 对于包含特殊字符的标签，使用原始标签
          TARGET_TAG="${{ matrix.service.tag }}-${ARCHITECTURE}"
          TARGET_IMAGE="${REGISTRY}/${NAMESPACE}/${{ matrix.service.name }}:${TARGET_TAG}"
          
          echo "=========================================="
          echo "Processing: ${{ matrix.service.name }}"
          echo "Source Image: $SOURCE_IMAGE"
          echo "Target Image: $TARGET_IMAGE"
          echo "Platform: linux/${ARCHITECTURE}"
          echo "Registry: ${REGISTRY}"
          echo "Namespace: ${NAMESPACE}"
          echo "=========================================="
          
          # 验证镜像路径格式
          if [[ "$SOURCE_IMAGE" == *"ghcr.io"* ]] || [[ "$SOURCE_IMAGE" == *"codefuse-ai"* ]]; then
            echo "❌ ERROR: Invalid source image path detected: $SOURCE_IMAGE"
            echo "Expected format: infiniflow/ragflow:v0.9.0"
            exit 1
          fi
          
          # 拉取源镜像，添加重试机制和空间清理
          MAX_RETRIES=3
          RETRY_COUNT=0
          PULL_SUCCESS=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            # 重试前清理空间（第一次已经在初始清理中完成）
            if [ $RETRY_COUNT -gt 0 ]; then
              echo "=== 重试前清理 Docker 空间 ==="
              docker system prune -a -f --volumes || true
              echo "=== 当前磁盘使用情况 ==="
              df -h
              docker system df
              sleep 5
            fi
            
            echo "Attempting to pull: $SOURCE_IMAGE (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
            
            # 使用 --platform 参数只拉取指定架构，减少空间占用
            if docker pull --platform linux/${ARCHITECTURE} "$SOURCE_IMAGE"; then
              echo "✅ Successfully pulled: $SOURCE_IMAGE"
              PULL_SUCCESS=true
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "⚠️ Pull failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
                sleep 10
              else
                echo "❌ Failed to pull $SOURCE_IMAGE after $MAX_RETRIES attempts"
                echo "Please verify the image exists at: https://hub.docker.com/r/${{ matrix.service.source }}"
                exit 1
              fi
            fi
          done
          
          if [ "$PULL_SUCCESS" = false ]; then
            echo "❌ Failed to pull image after all retries"
            exit 1
          fi
          
          # 标记镜像
          echo "=== 标记镜像 ==="
          docker tag "$SOURCE_IMAGE" "$TARGET_IMAGE"
          echo "✅ Tagged: $TARGET_IMAGE"
          
          # 推送镜像到阿里云，添加重试机制
          echo "=== 推送镜像到阿里云 ==="
          RETRY_COUNT=0
          PUSH_SUCCESS=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempting to push: $TARGET_IMAGE (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
            if docker push "$TARGET_IMAGE"; then
              echo "✅ Successfully pushed: $TARGET_IMAGE"
              PUSH_SUCCESS=true
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "⚠️ Push failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
                sleep 5
              else
                echo "❌ Failed to push $TARGET_IMAGE after $MAX_RETRIES attempts"
                # 推送失败时也清理本地镜像
                docker rmi "$SOURCE_IMAGE" "$TARGET_IMAGE" || true
                exit 1
              fi
            fi
          done
          
          if [ "$PUSH_SUCCESS" = true ]; then
            # 推送成功后立即删除本地镜像以释放空间
            echo "=== 清理本地镜像（推送成功） ==="
            docker rmi "$SOURCE_IMAGE" "$TARGET_IMAGE" || true
            # 清理未使用的资源
            docker system prune -f || true
            echo "✅ Completed: ${{ matrix.service.name }}"
            echo "=== 清理后磁盘使用情况 ==="
            df -h
            docker system df
          else
            echo "❌ Failed to push image after all retries"
            exit 1
          fi

      - name: Final cleanup
        if: always()
        run: |
          echo "=== 最终清理 Docker 系统 ==="
          docker system prune -a -f --volumes || true
          echo "=== 最终磁盘使用情况 ==="
          df -h
          docker system df
          echo "✅ Cleanup completed"

