name: Sync Docker Images to Aliyun

on:
  workflow_dispatch:  # 允许手动触发工作流

env:
  DOCKER_CLI_EXPERIMENTAL: enabled

jobs:
  sync-image:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        architecture: [amd64]
        service:
          - name: ragflow
            source: infiniflow/ragflow
            tag: v0.9.0
    steps:
      - name: Set up variables
        run: |
          # 硬编码的配置
          REGISTRY="crpi-ula1bfbb1264p5ln.cn-hangzhou.personal.cr.aliyuncs.com"
          NAMESPACE="muagent_gz"
          ARCHITECTURE="${{ matrix.architecture }}"
          PLATFORM="linux/${ARCHITECTURE}"
          
          # 构建源镜像名称
          SOURCE_IMAGE="${{ matrix.service.source }}:${{ matrix.service.tag }}"
          
          # 构建目标镜像名称
          TARGET_TAG="${{ matrix.service.tag }}-${ARCHITECTURE}"
          TARGET_IMAGE="${REGISTRY}/${NAMESPACE}/${{ matrix.service.name }}:${TARGET_TAG}"
          
          echo "SOURCE_IMAGE=${SOURCE_IMAGE}" >> $GITHUB_ENV
          echo "TARGET_IMAGE=${TARGET_IMAGE}" >> $GITHUB_ENV
          echo "PLATFORM=${PLATFORM}" >> $GITHUB_ENV
          echo "TARGET_REGISTRY=${REGISTRY}" >> $GITHUB_ENV

      - name: Clean up Docker space before pull
        run: |
          echo "=== 清理 Docker 空间 ==="
          # 清理未使用的容器
          docker container prune -f || true
          # 清理未使用的镜像
          docker image prune -a -f || true
          # 清理构建缓存
          docker builder prune -a -f || true
          # 清理未使用的卷
          docker volume prune -f || true
          # 清理未使用的网络
          docker network prune -f || true
          # 显示磁盘使用情况
          df -h
          docker system df

      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.TARGET_REGISTRY }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: Pull and push image (with cleanup)
        run: |
          set +e
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "=== 尝试拉取镜像 (第 $((RETRY_COUNT + 1)) 次) ==="
            
            # 清理空间（每次重试前都清理）
            if [ $RETRY_COUNT -gt 0 ]; then
              echo "清理 Docker 空间..."
              docker system prune -a -f --volumes || true
              df -h
            fi
            
            # 使用 --platform 参数只拉取指定平台，减少空间占用
            if docker pull --platform ${{ env.PLATFORM }} ${{ env.SOURCE_IMAGE }}; then
              echo "✓ 镜像拉取成功"
              
              # 立即标记为目标镜像
              docker tag ${{ env.SOURCE_IMAGE }} ${{ env.TARGET_IMAGE }}
              
              # 推送到阿里云
              echo "=== 推送镜像到阿里云 ==="
              if docker push ${{ env.TARGET_IMAGE }}; then
                echo "✓ 镜像推送成功"
                
                # 推送成功后立即删除本地镜像以释放空间
                echo "=== 清理本地镜像 ==="
                docker rmi ${{ env.SOURCE_IMAGE }} ${{ env.TARGET_IMAGE }} || true
                docker system prune -f || true
                
                echo "✓ 镜像同步完成"
                exit 0
              else
                echo "✗ 镜像推送失败"
                docker rmi ${{ env.SOURCE_IMAGE }} ${{ env.TARGET_IMAGE }} || true
                exit 1
              fi
            else
              echo "✗ 镜像拉取失败"
              RETRY_COUNT=$((RETRY_COUNT + 1))
              
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "等待 10 秒后重试..."
                sleep 10
              fi
            fi
          done
          
          echo "✗ 镜像拉取失败，已重试 $MAX_RETRIES 次"
          exit 1

      - name: Final cleanup
        if: always()
        run: |
          echo "=== 最终清理 ==="
          docker system prune -a -f --volumes || true
          df -h
          docker system df

