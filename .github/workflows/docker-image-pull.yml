name: Docker Image CI Pull

on:
  workflow_dispatch:  # 允许手动触发工作流
  schedule:
    # 每天 UTC 时间 02:00 自动运行（北京时间 10:00）
    - cron: '0 2 * * *'
  push:
    branches:
      - main
      - master
    paths:
      - 'docker/**'
      - 'Dockerfile*'
      - '.github/workflows/docker-image-ci-pull.yml'

jobs:
  pull-images:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # 允许单个镜像失败不影响其他镜像
      matrix:
        service:
          # 核心服务镜像
          - name: ragflow
            source: infiniflow/ragflow
            tag: v0.22.1
          
          # 必选基础依赖镜像
          - name: mysql
            source: mysql
            tag: 8.0.39
          
          - name: minio
            source: quay.io/minio/minio
            tag: RELEASE.2025-06-13T11-33-47Z
          
          - name: valkey
            source: valkey/valkey
            tag: "8"
          
          # 向量/检索引擎
          - name: elasticsearch
            source: elasticsearch
            tag: 8.11.3
          
          - name: infinity
            source: infiniflow/infinity
            tag: v0.6.11
          
          - name: opensearch
            source: hub.icert.top/opensearchproject/opensearch
            tag: 2.19.1
          
          # 可视化和管理工具
          - name: kibana
            source: kibana
            tag: 8.11.3
          
          # 代码执行沙箱
          - name: sandbox-executor-manager
            source: infiniflow/sandbox-executor-manager
            tag: latest
          
          - name: sandbox-base-python
            source: infiniflow/sandbox-base-python
            tag: latest
          
          - name: sandbox-base-nodejs
            source: infiniflow/sandbox-base-nodejs
            tag: latest
          
          # 数据库替代方案
          - name: oceanbase-ce
            source: oceanbase/oceanbase-ce
            tag: 4.4.1.0-100000032025101610

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: registry.cn-hangzhou.aliyuncs.com
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: Pull and push Docker image
        continue-on-error: true  # 允许单个镜像失败，继续处理其他镜像
        run: |
          set +e  # 允许命令失败，由脚本自己处理错误
          
          ARCHITECTURE="amd64"
          SOURCE_IMAGE="${{ matrix.service.source }}:${{ matrix.service.tag }}"
          TARGET_IMAGE="registry.cn-hangzhou.aliyuncs.com/muagent_gz/${{ matrix.service.name }}:${{ matrix.service.tag }}-${ARCHITECTURE}"
          
          echo "=========================================="
          echo "Processing: ${{ matrix.service.name }}"
          echo "Source: $SOURCE_IMAGE"
          echo "Target: $TARGET_IMAGE"
          echo "Platform: linux/${ARCHITECTURE}"
          echo "=========================================="
          
          # 拉取源镜像（x86_64/amd64 架构），添加重试机制
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if docker pull --platform linux/${ARCHITECTURE} "$SOURCE_IMAGE"; then
              echo "✅ Successfully pulled: $SOURCE_IMAGE"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "⚠️ Pull failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
                sleep 5
              else
                echo "❌ Failed to pull $SOURCE_IMAGE after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done
          
          # 标记镜像
          docker tag "$SOURCE_IMAGE" "$TARGET_IMAGE"
          echo "✅ Tagged: $TARGET_IMAGE"
          
          # 推送镜像到阿里云，添加重试机制
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if docker push "$TARGET_IMAGE"; then
              echo "✅ Successfully pushed: $TARGET_IMAGE"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "⚠️ Push failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
                sleep 5
              else
                echo "❌ Failed to push $TARGET_IMAGE after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done
          
          echo "✅ Completed: ${{ matrix.service.name }}"

      - name: Clean up
        if: always()
        run: |
          echo "Cleaning up Docker system..."
          docker system prune -af --volumes || true
          echo "Cleanup completed"

  # 单独处理 RAGFlow nightly 版本
  pull-ragflow-nightly:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: registry.cn-hangzhou.aliyuncs.com
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: Pull and push RAGFlow nightly image
        run: |
          set -e
          
          ARCHITECTURE="amd64"
          SOURCE_IMAGE="infiniflow/ragflow:nightly"
          TARGET_IMAGE="registry.cn-hangzhou.aliyuncs.com/ragflow/ragflow:nightly-${ARCHITECTURE}"
          
          echo "=========================================="
          echo "Processing: RAGFlow nightly"
          echo "Source: $SOURCE_IMAGE"
          echo "Target: $TARGET_IMAGE"
          echo "Platform: linux/${ARCHITECTURE}"
          echo "=========================================="
          
          # 拉取镜像，添加重试机制
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if docker pull --platform linux/${ARCHITECTURE} "$SOURCE_IMAGE"; then
              echo "✅ Successfully pulled: $SOURCE_IMAGE"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "⚠️ Pull failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
                sleep 5
              else
                echo "❌ Failed to pull $SOURCE_IMAGE after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done
          
          docker tag "$SOURCE_IMAGE" "$TARGET_IMAGE"
          echo "✅ Tagged: $TARGET_IMAGE"
          
          # 推送镜像，添加重试机制
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if docker push "$TARGET_IMAGE"; then
              echo "✅ Successfully pushed: $TARGET_IMAGE"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "⚠️ Push failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
                sleep 5
              else
                echo "❌ Failed to push $TARGET_IMAGE after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done
          
          echo "✅ Completed: RAGFlow nightly"

      - name: Clean up
        if: always()
        run: |
          echo "Cleaning up Docker system..."
          docker system prune -af --volumes || true
          echo "Cleanup completed"

